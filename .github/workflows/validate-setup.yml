name: Validate CI Setup

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/**'
      - 'package.json'
      - 'playwright.config.ts'

jobs:
  validate-setup:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Validate package.json
      run: |
        echo "ðŸ” Validating package.json..."
        if ! command -v jq &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y jq
        fi
        
        # Verificar que existan los scripts necesarios
        if ! jq -e '.scripts.build' package.json > /dev/null; then
          echo "âŒ Script 'build' no encontrado en package.json"
          exit 1
        fi
        
        if ! jq -e '.scripts.start' package.json > /dev/null; then
          echo "âŒ Script 'start' no encontrado en package.json"
          exit 1
        fi
        
        # Verificar dependencias crÃ­ticas
        if ! jq -e '.devDependencies["@playwright/test"]' package.json > /dev/null; then
          echo "âŒ Playwright no estÃ¡ instalado"
          exit 1
        fi
        
        if ! jq -e '.devDependencies["wait-on"]' package.json > /dev/null; then
          echo "âŒ wait-on no estÃ¡ instalado"
          exit 1
        fi
        
        echo "âœ… package.json vÃ¡lido"
    
    - name: Validate Playwright config
      run: |
        echo "ðŸ” Validating Playwright configuration..."
        if [ ! -f "playwright.config.ts" ]; then
          echo "âŒ playwright.config.ts no encontrado"
          exit 1
        fi
        echo "âœ… Playwright config existe"
    
    - name: Check GitHub workflows
      run: |
        echo "ðŸ” Validating GitHub workflows..."
        if [ ! -f ".github/workflows/ci.yml" ]; then
          echo "âŒ CI workflow no encontrado"
          exit 1
        fi
        
        # Verificar que el workflow tenga los jobs necesarios
        if ! grep -q "build-and-test:" .github/workflows/ci.yml; then
          echo "âŒ Job 'build-and-test' no encontrado en CI workflow"
          exit 1
        fi
        
        echo "âœ… GitHub workflows vÃ¡lidos"
    
    - name: Setup summary
      run: |
        echo "## âœ… ConfiguraciÃ³n de CI Validada" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Componentes verificados:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… package.json con scripts requeridos" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dependencias de Playwright instaladas" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… wait-on para sincronizaciÃ³n de servidor" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ConfiguraciÃ³n de Playwright presente" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Workflow de CI configurado correctamente" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### PrÃ³ximos pasos:" >> $GITHUB_STEP_SUMMARY
        echo "1. ðŸ”’ Configurar Branch Protection Rules en Settings > Branches" >> $GITHUB_STEP_SUMMARY
        echo "2. ðŸ§ª Crear una PR de prueba para validar el flujo" >> $GITHUB_STEP_SUMMARY
        echo "3. ðŸ“Š Verificar que los status checks aparezcan correctamente" >> $GITHUB_STEP_SUMMARY
